<!DOCTYPE html>
<html lang="ja">

<head>
    <title>LanaVerse</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="bmstable" content="header.json" />
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
<header class="mb-3">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">LanaVerse</span>
        </div>
    </nav>
</header>

<div class="container">

    <div class="alert alert-success mb-3" role="alert">
        <p>Lanaitが好きな譜面まとめ。</p>
        <p>地力LNソフランがメインコンテンツ。</p>
        <hr>
        <p class="mb-0">レベルはすべてSatellite基準ですが参考程度に。</p>
    </div>

    <div>
        <table class="table table-light table-striped table-hover" id="table_int"></table>
    </div>

<script>
$(document).ready(function () {
    $.getJSON($("meta[name=bmstable]").attr("content"), function (header) {
        $.getJSON(header.data_url, function (information) {
            makeBMSTable(information, header.symbol);
        });
    });
});

function isHttpUrl(url) {
    if (!url) return false;
    return /^https?:\/\/.+/i.test(url);
}

function makeLinkCell(url, label) {
    if (isHttpUrl(url)) {
        // rel="noopener noreferrer" で安全寄り
        return "<a href='" + url + "' target='_blank' rel='noopener noreferrer'>" + label + "</a>";
    }
    return "-";
}

function makeBMSTable(info, mark) {
    var x = "";
    var count = 0;
    var obj = $("#table_int");

    obj.html("");

    $("<thead class='table-dark'><tr>" +
        "<th>Level</th>" +
        "<th>Title</th>" +
        "<th>Artist</th>" +
        "<th>本体</th>" +
        "<th>差分</th>" +
        "<th>Comment</th>" +
      "</tr></thead><tbody>").appendTo(obj);

    var obj_sep = null;

    for (var i = 0; i < info.length; i++) {

        if (x != info[i].level) {
            if (obj_sep != null) {
                obj_sep.html("<td colspan='6'><b>" + mark + x + " (" + count + "譜面)</b></td>");
            }

            obj_sep = $("<tr class='table-dark' style='text-align:center' id='" +
                        mark + info[i].level + "'></tr>");
            obj_sep.appendTo(obj);

            count = 0;
            x = info[i].level;
        }

        var str = $("<tr></tr>");

        // Level
        $("<td width='5%'>" + mark + x + "</td>").appendTo(str);

        // Title (LR2IR)
        $("<td width='42%'>" +
            "<a href='http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=" +
            info[i].md5 + "' target='_blank' rel='noopener noreferrer'>" +
            info[i].title + "</a></td>").appendTo(str);

        // Artist
        $("<td width='33%'>" + info[i].artist + "</td>").appendTo(str);

        // 本体リンク（スプレッドシート側で body_url を入れる）
        $("<td width='6%'>" + makeLinkCell(info[i].body_url, "本体") + "</td>").appendTo(str);

        // 差分リンク（スプレッドシート側で diff_url を入れる）
        $("<td width='6%'>" + makeLinkCell(info[i].diff_url, "差分") + "</td>").appendTo(str);

        // Comment
        $("<td width='8%'>" + (info[i].comment || "") + "</td>").appendTo(str);

        str.appendTo(obj);
        count++;
    }

    $("</tbody>").appendTo(obj);

    if (obj_sep != null) {
        obj_sep.html("<td class='table-dark' style='text-align:center' colspan='6'>" +
            "<b>" + mark + x + " (" + count + "譜面)</b></td>");
    }
}
</script>

</div>
</body>
</html>
